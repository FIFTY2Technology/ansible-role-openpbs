---

- name: Prerequisites
  ansible.builtin.import_tasks: preflight.yml

- name: Install required packages for building and running OpenPBS on Debian
  ansible.builtin.include_tasks: install_Debian.yml
  when:
    - ansible_os_family == 'Debian'
    - ansible_distribution == 'Debian'

- name: Install required packages for building and running OpenPBS on Ubuntu
  ansible.builtin.include_tasks: install_Ubuntu.yml
  when:
    - ansible_os_family == 'Debian'
    - ansible_distribution == 'Ubuntu'

- name: Install required packages for building and running OpenPBS on CentOS
  ansible.builtin.include_tasks: install_CentOS.yml
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution == 'CentOS'

###
# Other distributions (we use) are not supported by OpenPBS.
###

- name: Import download tasks
  ansible.builtin.import_tasks: download.yml

###
# Only run this block for nodes with old versions (or absent versions, defined
# by '_openpbs_installed_version: 0.0' in 'preflight.yml').
###
- name: Unpack and compile if outdated version of OpenPBS was found
  block:
    - name: Import unpack tasks
      ansible.builtin.import_tasks: unpack.yml

    - name: Import compile tasks
      ansible.builtin.import_tasks: compile.yml
  when:
    - _openpbs_installed_version is version( openpbs_version, '<' )

- name: Import configure tasks
  ansible.builtin.import_tasks: configure.yml

- name: Enable and start PBS service
  ansible.builtin.systemd:
    name: pbs
    enabled: true
    state: started
